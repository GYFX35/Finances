<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}My Social Network{% endblock %}</title>
    {% block head_extra %}{% endblock %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon-180x180.png') }}" sizes="180x180">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
    <nav>
        <a href="{{ url_for('hello_world') }}">Home</a> |
        <a href="{{ url_for('signup') }}">Sign Up</a> |
        <a href="{{ url_for('create_business') }}">Create Business</a> |
        <a href="{{ url_for('view_marketing_forum') }}">Marketing Forum</a> |
        <a href="{{ url_for('view_sales_list') }}">Sales Transactions</a> |
        <a href="{{ url_for('view_banks_list') }}">Banks Directory</a> |
        <a href="{{ url_for('view_fintech_tools_list') }}">Fintech Tools</a> |
        <a href="{{ url_for('view_jobs_list') }}">Jobs</a> |
        <a href="{{ url_for('view_news_list') }}">News</a> |
        <a href="{{ url_for('global_chat_page') }}">Chat</a> |
        <a href="{{ url_for('view_esports_schedule') }}">Esports Schedule</a> |
        <a href="{{ url_for('view_suppliers_list') }}">Dropshipping Suppliers</a> |
        <a href="{{ url_for('view_guides_list') }}">Dropshipping Guides</a> |
        <a href="{{ url_for('view_product_blogs_list') }}">Product Blog</a>
    </nav>
    <hr>
    {% block content %}
    {% endblock %}

    <div style="padding: 10px; text-align: center;">
        <button id="enableNotificationsButton">Enable Notifications</button>
        <p id="notificationStatus" style="font-size: 0.9em;"></p>
    </div>

    <script>
    const VAPID_PUBLIC_KEY = 'BPEzWZhtqV_fH_e_JTN0m_0xZgsqLqUnv1n4T0gC6Z7Fw3f_J9qY8h8L0pZ7jJ8rN6sC_xH_tK_lP9vO_lR0eDc'; // REPLACE with your actual VAPID public key

    // Helper function to convert URL-safe base64 string to Uint8Array
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    const enableNotificationsButton = document.getElementById('enableNotificationsButton');
    const notificationStatus = document.getElementById('notificationStatus');

    if ('Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window) {
        enableNotificationsButton.addEventListener('click', () => {
            notificationStatus.textContent = 'Requesting permission...';
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    notificationStatus.textContent = 'Notification permission granted. Subscribing...';
                    navigator.serviceWorker.ready.then(registration => {
                        const subscribeOptions = {
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                        };
                        return registration.pushManager.subscribe(subscribeOptions);
                    })
                    .then(pushSubscription => {
                        console.log('Received PushSubscription: ', JSON.stringify(pushSubscription));
                        notificationStatus.textContent = 'Successfully subscribed to push notifications!';
                        // TODO: Send pushSubscription to your server here
                        enableNotificationsButton.disabled = true;
                        return pushSubscription;
                    })
                    .catch(error => {
                        console.error('Failed to subscribe to push manager: ', error);
                        notificationStatus.textContent = 'Failed to subscribe: ' + error.message;
                    });
                } else if (permission === 'denied') {
                    notificationStatus.textContent = 'Notification permission denied.';
                    enableNotificationsButton.disabled = true;
                } else {
                    notificationStatus.textContent = 'Notification permission not granted (dismissed).';
                }
            });
        });
    } else {
        if(notificationStatus) notificationStatus.textContent = 'Push notifications are not supported by your browser.';
        if(enableNotificationsButton) enableNotificationsButton.style.display = 'none';
    }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("/sw.js") // Direct path to root sw.js
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
